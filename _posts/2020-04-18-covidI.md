---
layout: posts
title: Mapping COVID-19 statistics using Folium and pandas - Part I
published: true
header:
  overlay_image: /assets/images/map_overlay.jpg
  overlay_filter: 0.2
---

Why not take advantage of Python's [Folium](https://python-visualization.github.io/folium/index.html) mapping library to visualize the COVID-19 statistics?

This is what my buddy Pierre and I decided to do in order to map the number of coronavirus-related deaths for metropolitan France, based on the data issued by France's Regional Health Agency (ARS or *Agence Régionale de Santé*). Our goal was to represent the death toll per department, or *département*, a French territorial subdivision.

In the next couple of posts, I will describe our project's main steps. The current post will be dedicated to backend aspects, while the next one will focus on the webpage deployment. 
By the time you are done reading, you should be able to produce a similar map to meet your needs; hopefully you will be working on a less depressing project! Let's dive in!

### Importing libraries and geographical coordinates

The stars of the show are Folium and pandas, which we will use not only to load the data, but also to manipulate them.

```python
import folium
import numpy as np
import datetime
import pandas as pd
import unidecode
import branca.colormap as cm
colormap =cm.linear.YlOrRd_09.scale(0, 1000)
```

We also need to load the geographical coordinates of each department, stored as a dictionary. It would be possible to have the dictionary directly in the main python script, but for the sake of housekeeping, we keep it inside an external file called `department.py`:

```python
coordinates={                
                  'DEP-29': [48.26111111, -4.058888889], 
                  'DEP-22': [48.44111111, -2.864166667], 
                  'DEP-56': [47.84638889, -2.81], 
                  ...
                  'DEP-95': [49.08277778, 2.131111111],
                  'DEP-2B': [42.39416667, 9.206388889],
                  'DEP-2A': [41.86361111, 8.988055556]
                  }                  
```

Associated with each department code (*e.g.* DEP-29) is a latitude and longitude pair (*e.g.*  [48.26111111, -4.058888889]), corresponding to the geographical center of the department, as computed by France's National Geographical Institute (IGN or [*Institut Géographique National*](http://www.ign.fr/institut/actus/lign-calcule-centre-geographique-96-departements-metropolitains)). 
We just need to import department like we would do with any built-in library:

```python
import department
```

### Downloading the data from GitHub

Next, we need to download the data, hosted on the [Open COVID-19 GitHub page] (https://github.com/opencovid19-fr). If you are even remotely interested into France's coronavirus stats, I strongly suggest that you check it out.

In order to do fecth the data, we define a function `download_csv_from_github()`:

```python
def download_csv_from_github():
     download_start_time=datetime.datetime.now()
     data=pd.read_csv('https://raw.githubusercontent.com/opencovid19-fr/data/master/dist/chiffres-cles.csv')
     download_end_time=datetime.datetime.now()  
     download_duration=download_end_time-download_start_time
     return data, download_duration
```

This is essentially a wrapper for pandas `read_csv` function, which stores the content of the csv file into a dataframe called data. The download start and end time just serve troubleshooting purpose and will be discussed later on.

### Define CovidData class

We are now ready to roll! Let's define a class called `CovidData`. 

```python
class CovidData(object):
   
    def __init__(self):
         self.Data, self.download_duration = download_csv_from_github()
         self.Departements = departements.coordinates         
         self.Coordinates=pd.DataFrame.from_dict(self.Departements, orient='index')
         self.Coordinates['maille_code']=self.Coordinates.index         
         self.map = folium.Map(location=[46,2],
              tiles = 'Stamen Terrain',
              zoom_start=6)         
         self.merged_data_last = None
         self.merged_data_penultimate = None


    def merge_data_and_coordinates(self):
         self.merged_data=self.Data.merge(self.Coordinates, left_on='maille_code', right_on='maille_code')

    def drop_rows_with_missing_info(self):
         self.merged_data=self.merged_data.dropna(subset=['deces'])

    def select_last_date(self):
         self.merged_data_last=self.merged_data.sort_values('date').groupby('maille_code').tail(1)

    def select_penultimate_date(self):
         merged_data_penultimate_temp=self.merged_data.sort_values('date').groupby('maille_code').tail(2)
         self.merged_data_penultimate=merged_data_penultimate_temp.sort_values('date').groupby('maille_code').head(1)

    def compute_change_over_the_last_day(self):
          self.merged_data_diff=self.merged_data_last.merge(self.merged_data_penultimate, left_on='maille_code', right_on='maille_code')
          self.merged_data_diff['difference']=self.merged_data_diff['deces_x']-self.merged_data_diff['deces_y']
          self.merged_data_diff.to_csv('difftest.csv')

    def plot_departements(self,data,custom_color):
         radius = data['deces_x'].values.astype('float')
         latitude = data['0_x'].values.astype('float')
         longitude = data['1_y'].values.astype('float')
         nom = data['maille_nom_x'].values.astype('str')   
         latest_date = data['date_x'].values.astype('str')
         penultimate_date = data['date_y'].values.astype('str')         
         difference = data['difference'].values.astype('str')
         for la,lo,ra,no,di,ld,pd in zip(latitude,longitude,radius,nom,difference,latest_date,penultimate_date):
              label=unidecode.unidecode(no.replace("'","-"))+': '+str(ra)[:-2]+ ' victims by '+str(ld)+'. +'+str(di)[:-2]+' cases since '+str(pd)+'.'
              folium.Circle(
                       location=[la,lo],
                       radius=5000*np.log(ra),
                       fill=True,
                       color='grey',
                       fill_color=colormap(ra),
                       fill_opacity=0.8
                   ).add_child(folium.Popup(label)).add_to(self.map)
```

The `__init__` constructor allows us to initialize several attributes, among which:

- `Data`, the dataframe obtained by calling the aforementioned `download_csv_from_github` function.
- `Coordinates`, a dataframe containing the latitude and longitude of each region, built from the `coordinates` dictionary through the `from_dict` method.
- `map`, our Folium map. Right now, this is just a plain map of France. It takes bit of fiddling to ajust the central latitude and longitude passed in the `location` parameter, as well as the right `zoom` level. Last but not least, the map style is defined in the `tiles` parameter: check out Folium's doc for more built-in themes.


