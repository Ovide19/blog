---
layout: posts
title: Mapping COVID-19 statistics using Folium and pandas - Part II
published: true
header:
  overlay_image: /assets/images/map_overlay.jpg
  overlay_filter: 0.2
tags: [flask, heroku, folium]
---

Now that our Covid-19 map is up and running, let's create a Heroku-hosted flask app to make it available online.

### 1. Adding an html legend to the map

Before publishing our map, let's add some extra information on top of it, such as the data provenance.
In order to do this, let's create an html legend. We can do this right after the import statements:
 
```python
legend_html = '''
<div style="position: fixed;
     padding: .5em; top: 10px; left: 60px; width: 30em; height: 10em;
     border:2px solid grey; z-index:9999; font-size:14px; background: #eee;
     "> &nbsp; COVID-19 related deaths for Metropolitan France<br>
     &nbsp; Data recovered from https://github.com/opencovid19-fr/data  <br>
</div>
'''
```

Upon instantiation of the `CovidData` class, we can easily display this legend using:

```python
CODA.map.get_root().html.add_child(folium.Element(legend_html))
```

Our `create_map` function now looks like this:

```python
def create_map():
     CODA=CovidData()
     CODA.merge_data_and_coordinates()
     CODA.drop_rows_with_missing_info()
     CODA.select_last_date()
     CODA.plot_departments(CODA.merged_data_last,'grey')
     CODA.map.get_root().html.add_child(folium.Element(legend_html))
     colormap.caption = 'COVID-19 death toll per department (Source: opencovid19-fr)'
     CODA.map.add_child(colormap)
     return CODA
```

### 2. Creating a flask app

With the legend out of the way, let's create a web app to display our map. This is where [Flask](https://flask.palletsprojects.com/en/1.1.x/) steps in. Flask is a python web microframework, designed to be simple, yet extensible. 

No big surprise here: the first thing to do is to import `flask`. We will also need `os` along the way:

```python
from flask import Flask
import os
```

We can now comment out the code line used to save our map as an html file, since we won't need it anymore:

```python
#Coda.map.save("./COVID_map.html")
```

Instead, let's append the following code block at the end of our script:

```python
app = Flask(__name__)

@app.route("/")
def display_map():
     CODA = create_map()
     return CODA.map._repr_html_()

if __name__ == '__main__':
    app.run()
```

Fortunately for us, this code block is barely more complicated than [flask's *Hello World*](https://flask.palletsprojects.com/en/1.1.x/quickstart/)!
```python app = Flask(__name__)``` creates the `app` object, an instance of the `Flask` class; this is done by passing the `__name__` argument to the `Flask`constructor.
The next step is to tell `app` how to process incoming requests. This is achived using the `route()` dectorator, which binds the function `display_map()` to URL `'/'`. In other words, when the application receives a request where the path is `'/'`, it invokes `display_map()`.

What `display_map()` does, is simply call our `create_map()` function and display the `CODA` object it returns using `_repr_html_()`.

Last but not least, the app is started by using the `run()` method. Here neither host nor port are specified, so `host` defaults to the localhost and port defauts to 5000.

We're done! If you run the script and type "127.0.0.1:5000/" into your browser, you should see the map popping up!
Right now, it only runs locally, but we are just one step away from making it available online.


### 3. Hosting the app on heroku

We will operate our application from [Heroku](www.heroku.com), a platform.

First go ahead an change the last line of the script to:

```python 
if __name__ == '__main__':
    app.run(host='0.0.0.0', port=os.environ.get('PORT', 80))
```

Alternatively, you can download the full script [here](https://github.com/Ovide19/blog_scripts/tree/master/2020-05-20-covidII).

Go ahead and create a Heroku account. Your dashboard should look something like this:

![The heroku dashboard](/blog/assets/images/heroku.jpg)

Click on the top right "New" button and select "Create a new app" in the dropdown menu. Heroku will ask to specify the app name, as well as the server region. Here I go for covid19-viz-blog. Go ahead a hit the "Create app" button.

![Creating a new app](/blog/assets/images/heroku2.jpg)